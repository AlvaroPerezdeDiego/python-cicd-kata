name: Code Quality Checks
run-name: ${{ github.actor }} is checking code quality ðŸš€
on:
  push:
    branches:
      - main
jobs:
  check-linter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: "Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install the project
        run: uv sync --all-extras --dev
        shell: bash

      - name: Run linter chcks
        run: uv run ruff check .
        shell: bash

  check-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: "Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install the project
        run: uv sync --all-extras --dev
        shell: bash

      - name: Run linter chcks
        run: uv run ruff format --check .
        shell: bash

  check-type-safety:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: "Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install the project
        run: uv sync --all-extras --dev
        shell: bash

      - name: Run linter chcks
        run: uv run pyright
        shell: bash

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: "Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install the project
        run: uv sync --all-extras --dev
        shell: bash

      - name: Run unit tests
        run: uv run pytest tests
        shell: bash

  docker:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [check-linter, check-format, check-type-safety, unit-tests]
    steps:
    - uses: actions/checkout@v5

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push
      uses: docker/build-push-action@v6
      with:
        push: true
        tags: alvaroperezdd/python-kata-cicd-alvarop:latest

  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: docker
    steps:
    - name: Trigger render deploy
      run: |
        curl "${{ secrets.RENDER_WEBHOOK }}&imgURL=docker.io%2Falvaroperezdd%2Fpython-kata-cicd-alvarop%3Alatest"

